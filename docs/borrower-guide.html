<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borrower Guide - Lendefi Markets</title>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #e5e7eb;
            background: #111827;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo span {
            background: linear-gradient(135deg, #0ea5e9, #14b8a6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        
        .nav-links a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #14b8a6;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .docs-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .docs-header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #0ea5e9, #14b8a6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .docs-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 3rem;
        }
        
        .sidebar {
            background: rgba(17, 24, 39, 0.5);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: fit-content;
            position: sticky;
            top: 120px;
        }
        
        .sidebar h3 {
            color: #14b8a6;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .sidebar ul {
            list-style: none;
        }
        
        .sidebar li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar a {
            color: #9ca3af;
            text-decoration: none;
            padding: 0.5rem;
            display: block;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .sidebar a:hover {
            background: rgba(20, 184, 166, 0.1);
            color: #14b8a6;
        }
        
        .content {
            background: rgba(17, 24, 39, 0.5);
            padding: 3rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .content h2 {
            color: #14b8a6;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .content h3 {
            color: #0ea5e9;
            margin: 2rem 0 1rem 0;
        }
        
        .content h4 {
            color: #f59e0b;
            margin: 1.5rem 0 0.75rem 0;
        }
        
        .content p, .content li {
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        
        .content ul, .content ol {
            margin-left: 2rem;
            margin-bottom: 1rem;
        }
        
        .highlight {
            background: rgba(20, 184, 166, 0.1);
            border-left: 4px solid #14b8a6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 6px 6px 0;
        }
        
        .warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 6px 6px 0;
        }
        
        .danger {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 6px 6px 0;
        }
        
        .step-card {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            position: relative;
        }
        
        .step-number {
            position: absolute;
            top: -10px;
            left: 20px;
            background: #14b8a6;
            color: #111827;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }
        
        .step-title {
            color: #0ea5e9;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .code-block {
            background: #1f2937;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            overflow-x: auto;
        }
        
        .code-block code {
            color: #e5e7eb;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }
        
        .info-box {
            border-radius: 8px;
            padding: 16px;
            margin: 1rem 0;
        }
        
        .info-box.blue {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .info-box.green {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .info-box.yellow {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .info-box.purple {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .info-box.red {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 24px 0;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin: 24px 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-liquidated {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-closed {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .tier-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .tier-table th,
        .tier-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            text-align: left;
        }
        
        .tier-table th {
            background: rgba(20, 184, 166, 0.1);
            color: #14b8a6;
        }
        
        .health-indicator {
            background: linear-gradient(135deg, #10b981, #14b8a6);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
        }
        
        @media (max-width: 768px) {
            .docs-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .docs-header h1 {
                font-size: 2rem;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="nav">
                <div class="logo">
                    <span>Lendefi Markets</span>
                </div>
                <div class="nav-links">
                    <a href="/">Home</a>
                    <a href="index.html">Documentation</a>
                    <a href="market-owner-guide.html">Market Owner Guide</a>
                    <a href="lender-guide.html">Lender Guide</a>
                    <a href="/contact">Contact</a>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="docs-header">
                <h1><span class="gradient-text">Borrower</span> Guide</h1>
                <p>Complete guide to borrowing against collateral in Lendefi Markets</p>
            </div>

            <div class="docs-content">
                <aside class="sidebar">
                    <h3>Table of Contents</h3>
                    <ul>
                        <li><a href="#overview">Overview</a></li>
                        <li><a href="#getting-started">Getting Started</a></li>
                        <li><a href="#create-position">1. Create Position</a></li>
                        <li><a href="#supply-collateral">2. Supply Collateral</a></li>
                        <li><a href="#borrow-funds">3. Borrow Funds</a></li>
                        <li><a href="#manage-position">4. Manage Position</a></li>
                        <li><a href="#repay-close">5. Repay & Close</a></li>
                        <li><a href="#flash-loans">Flash Loans</a></li>
                        <li><a href="#collateral-tiers">Collateral Tiers</a></li>
                        <li><a href="#liquidation">Liquidation</a></li>
                        <li><a href="#mev-protection">MEV Protection</a></li>
                        <li><a href="#examples">Code Examples</a></li>
                    </ul>
                </aside>

                <div class="content">
                    <section id="overview">
                        <h2>Overview</h2>
                        <p>As a borrower in Lendefi Markets, you can access liquidity by depositing collateral assets and borrowing base assets from isolated lending markets. Each position is tracked individually, providing better risk management and regulatory compliance.</p>
                        
                        <div class="highlight">
                            <strong>Key Benefits for Borrowers:</strong>
                            <ul>
                                <li>Isolated positions for better risk management</li>
                                <li>Cross-market collateral support</li>
                                <li>Competitive interest rates based on market dynamics</li>
                                <li>MEV protection for all operations</li>
                                <li>No liquidation cascades between positions</li>
                                <li>Flexible collateral management</li>
                            </ul>
                        </div>

                        <div class="health-indicator">
                            üéØ Always maintain Health Factor &gt; 1.2 for safety
                        </div>

                        <div class="info-box blue">
                            <strong>How Borrowing Works:</strong>
                            <p>You create individual positions where you deposit collateral assets and borrow base assets. Each position has its own isolated vault contract, preventing cross-contamination and providing clear regulatory boundaries. Your borrowing capacity depends on the value and risk tier of your collateral.</p>
                        </div>
                    </section>

                    <section id="getting-started">
                        <h2>Getting Started</h2>
                        <p>Borrowing in Lendefi Markets requires understanding position lifecycle, collateral requirements, and risk management.</p>

                        <div class="grid-2">
                            <div class="info-box green">
                                <h5>‚úÖ What You Need</h5>
                                <ul>
                                    <li>Collateral assets (ETH, WBTC, stablecoins, etc.)</li>
                                    <li>Web3 wallet (MetaMask, WalletConnect, etc.)</li>
                                    <li>ETH for gas fees</li>
                                    <li>Understanding of liquidation risks</li>
                                </ul>
                            </div>
                            
                            <div class="info-box blue">
                                <h5>üìä Market Selection</h5>
                                <ul>
                                    <li>Choose markets with desired base assets</li>
                                    <li>Check available collateral types</li>
                                    <li>Compare borrowing rates across markets</li>
                                    <li>Assess market liquidity and utilization</li>
                                </ul>
                            </div>
                        </div>

                        <div class="info-box yellow">
                            <strong>üßÆ Key Calculations:</strong>
                            <ul>
                                <li><strong>Credit Limit:</strong> Collateral Value √ó Loan-to-Value Ratio</li>
                                <li><strong>Health Factor:</strong> (Collateral Value √ó Liquidation Threshold) √∑ Total Debt</li>
                                <li><strong>Available to Borrow:</strong> Credit Limit - Current Debt</li>
                                <li><strong>Liquidation Price:</strong> Price at which Health Factor = 1.0</li>
                            </ul>
                        </div>
                    </section>

                    <section id="create-position">
                        <h2>Step 1: Create Position</h2>
                        <p>Start by creating a new borrowing position for your chosen collateral asset. This deploys an isolated vault contract for your position.</p>

                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-title">Choose Your Collateral Asset</div>
                            <p>Select the asset you want to use as collateral from the available options.</p>
                            
                            <div class="info-box purple">
                                <strong>Collateral Considerations:</strong>
                                <ul>
                                    <li><strong>Volatility:</strong> More stable assets = higher LTV ratios</li>
                                    <li><strong>Liquidity:</strong> Better liquidity = easier liquidation if needed</li>
                                    <li><strong>Your Holdings:</strong> Use assets you already own</li>
                                    <li><strong>Market Depth:</strong> Ensure sufficient oracle data</li>
                                </ul>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-title">Create the Position</div>
                            <p>Call the createPosition function to deploy your isolated position vault.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Create a position for WETH collateral
uint256 positionId = marketCore.createPosition(
    address(weth),    // Collateral asset address
    false            // isIsolated: false for cross-collateral, true for isolated
);

// Position ID is returned for all future operations
// Position vaults are deployed using minimal proxy pattern for gas efficiency</code></pre>
                            </div>

                            <div class="info-box green">
                                <strong>What Happens During Creation:</strong>
                                <ul>
                                    <li>Unique position ID is assigned</li>
                                    <li>Isolated vault contract is deployed</li>
                                    <li>Position status set to INACTIVE</li>
                                    <li>Ready to receive collateral deposits</li>
                                </ul>
                                <p><span class="status-badge status-inactive">Status: INACTIVE</span> - Position created but no collateral supplied yet</p>
                            </div>
                        </div>
                    </section>

                    <section id="supply-collateral">
                        <h2>Step 2: Supply Collateral</h2>
                        <p>Add collateral to your position to enable borrowing capacity. Collateral is securely stored in your isolated position vault.</p>

                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-title">Approve and Deposit</div>
                            <p>Approve the market contract and supply your collateral assets.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Approve the market core contract to transfer your collateral
uint256 collateralAmount = 50 ether; // 50 WETH
weth.approve(address(marketCore), collateralAmount);

// Supply collateral to your position
marketCore.supplyCollateral(
    address(weth),      // Collateral asset
    collateralAmount,   // Amount to supply
    positionId          // Your position ID
);</code></pre>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-title">Check Your Borrowing Capacity</div>
                            <p>Calculate how much you can borrow against your collateral.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Calculate your credit limit
uint256 creditLimit = marketCore.calculateCreditLimit(borrower, positionId);

// With 50 WETH at $2500 and 80% LTV:
// Credit Limit = 50 √ó $2500 √ó 0.80 = $100,000 USDC

// Check collateral value
uint256 collateralValue = marketCore.calculateCollateralValue(borrower, positionId);</code></pre>
                            </div>

                            <div class="info-box green">
                                <strong>Position Now Active:</strong>
                                <ul>
                                    <li>Collateral secured in isolated vault</li>
                                    <li>Borrowing capacity calculated</li>
                                    <li>Position ready for borrowing</li>
                                    <li>Health factor tracking enabled</li>
                                </ul>
                                <p><span class="status-badge status-active">Status: ACTIVE</span> - Position ready for borrowing</p>
                            </div>
                        </div>
                    </section>

                    <section id="borrow-funds">
                        <h2>Step 3: Borrow Funds</h2>
                        <p>Borrow base assets against your collateral, up to your credit limit. Interest begins accruing immediately upon borrowing.</p>

                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-title">Execute Borrow Transaction</div>
                            <p>Borrow base assets with MEV protection and slippage controls.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Borrow USDC against WETH collateral
uint256 borrowAmount = 80_000e6; // 80,000 USDC (staying below credit limit)
uint256 expectedCreditLimit = marketCore.calculateCreditLimit(borrower, positionId);

marketCore.borrow(
    positionId,           // Your position ID
    borrowAmount,         // Amount to borrow
    expectedCreditLimit,  // Expected credit limit (MEV protection)
    100                   // Maximum slippage in basis points (1%)
);</code></pre>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-title">Monitor Your Position</div>
                            <p>Track key metrics to ensure your position remains healthy.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Check your health factor (must stay above 1.0)
uint256 healthFactor = marketCore.healthFactor(borrower, positionId);

// Get current debt including accrued interest
uint256 currentDebt = marketCore.calculateDebtWithInterest(borrower, positionId);

// Check remaining borrowing capacity
uint256 remainingCredit = creditLimit - currentDebt;</code></pre>
                            </div>

                            <div class="info-box yellow">
                                <strong>Interest Accumulation:</strong>
                                <ul>
                                    <li>Interest begins accruing immediately upon borrowing</li>
                                    <li>Rates are dynamic based on market utilization</li>
                                    <li>Higher risk collateral tiers pay higher rates</li>
                                    <li>Interest compounds continuously</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section id="manage-position">
                        <h2>Step 4: Manage Your Position</h2>
                        <p>Actively monitor and manage your position to maintain health and optimize your borrowing strategy.</p>

                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-title">Health Factor Monitoring</div>
                            <p>Your most important metric - always keep this above 1.0 to avoid liquidation.</p>
                            
                            <div class="health-indicator">
                                Health Factor = (Collateral Value √ó Liquidation Threshold) √∑ Total Debt
                            </div>

                            <div class="grid-3">
                                <div class="info-box green">
                                    <h5>üü¢ Healthy</h5>
                                    <p><strong>HF &gt; 1.5:</strong> Safe position with good buffer</p>
                                </div>
                                
                                <div class="info-box yellow">
                                    <h5>üü° Caution</h5>
                                    <p><strong>HF 1.0-1.5:</strong> Monitor closely, consider adding collateral</p>
                                </div>
                                
                                <div class="info-box red">
                                    <h5>üî¥ Danger</h5>
                                    <p><strong>HF &lt; 1.0:</strong> Position can be liquidated</p>
                                </div>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-title">Position Management Options</div>
                            <p>Various actions you can take to manage your position risk and optimize borrowing.</p>
                            
                            <div class="grid-2">
                                <div class="info-box blue">
                                    <h5>üî∫ Increase Collateral</h5>
                                    <div class="code-block">
                                        <pre><code class="language-solidity">// Add more collateral to improve health factor
marketCore.supplyCollateral(
    address(weth),
    additionalAmount,
    positionId
);</code></pre>
                                    </div>
                                </div>
                                
                                <div class="info-box purple">
                                    <h5>üí∞ Repay Debt</h5>
                                    <div class="code-block">
                                        <pre><code class="language-solidity">// Repay some debt to improve health factor
usdc.approve(address(marketCore), repayAmount);
marketCore.repay(
    positionId,
    repayAmount,
    expectedDebt,
    100 // 1% slippage
);</code></pre>
                                    </div>
                                </div>
                            </div>

                            <div class="grid-2">
                                <div class="info-box green">
                                    <h5>üì§ Withdraw Collateral</h5>
                                    <div class="code-block">
                                        <pre><code class="language-solidity">// Withdraw excess collateral (if health allows)
marketCore.withdrawCollateral(
    address(weth),
    withdrawAmount,
    positionId,
    expectedCreditLimit,
    100
);</code></pre>
                                    </div>
                                </div>
                                
                                <div class="info-box yellow">
                                    <h5>üìä Borrow More</h5>
                                    <div class="code-block">
                                        <pre><code class="language-solidity">// Borrow additional funds (if credit available)
marketCore.borrow(
    positionId,
    additionalBorrowAmount,
                                    expectedCreditLimit,
                                    100
);</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-title">Monitoring Tools</div>
                            <p>Essential functions to track your position performance.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Complete position monitoring
function monitorPosition(address user, uint256 positionId) external view returns (
    uint256 healthFactor,
    uint256 collateralValue,
    uint256 currentDebt,
    uint256 creditLimit,
    bool isLiquidatable
) {
    healthFactor = marketCore.healthFactor(user, positionId);
    collateralValue = marketCore.calculateCollateralValue(user, positionId);
    currentDebt = marketCore.calculateDebtWithInterest(user, positionId);
    creditLimit = marketCore.calculateCreditLimit(user, positionId);
    isLiquidatable = marketCore.isLiquidatable(user, positionId);
}</code></pre>
                            </div>
                        </div>
                    </section>

                    <section id="repay-close">
                        <h2>Step 5: Repay & Close Position</h2>
                        <p>Repay your debt and withdraw collateral to close your position when ready.</p>

                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-title">Calculate Total Debt</div>
                            <p>Get the exact amount needed to fully repay your position including interest.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Get total debt including all accrued interest
uint256 totalDebt = marketCore.calculateDebtWithInterest(borrower, positionId);

// Add small buffer for any interest that might accrue during transaction
uint256 repayAmount = totalDebt + 100e6; // Add 100 USDC buffer</code></pre>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-title">Repay Full Debt</div>
                            <p>Repay the complete outstanding debt to clear your borrowing obligation.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Approve and repay full debt
usdc.approve(address(marketCore), repayAmount);

marketCore.repay(
    positionId,          // Your position ID
    repayAmount,         // Amount to repay (with buffer)
    totalDebt,           // Expected debt amount
    100                  // 1% max slippage
);</code></pre>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-title">Withdraw All Collateral</div>
                            <p>Once debt is fully repaid, withdraw all your collateral to close the position.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Withdraw all collateral after full debt repayment
uint256 collateralBalance = marketCore.getCollateralAmount(
    borrower, 
    positionId, 
    address(weth)
);

marketCore.withdrawCollateral(
    address(weth),              // Collateral asset
    collateralBalance,          // Full collateral amount
    positionId,                 // Position ID
    0,                          // Expected credit limit (0 after full repay)
    100                         // 1% max slippage
);</code></pre>
                            </div>

                            <div class="info-box green">
                                <strong>Position Successfully Closed:</strong>
                                <ul>
                                    <li>All debt repaid with interest</li>
                                    <li>All collateral withdrawn</li>
                                    <li>Position can be reused for future borrowing</li>
                                    <li>Gas costs minimized through efficient design</li>
                                </ul>
                                <p><span class="status-badge status-closed">Status: CLOSED</span> - Position closed successfully</p>
                            </div>
                        </div>
                    </section>

                    <section id="flash-loans">
                        <h2>Flash Loans</h2>
                        <p>Lendefi Markets provides uncollateralized flash loans that allow you to borrow large amounts of base assets for complex DeFi operations within a single transaction. Flash loans are perfect for arbitrage, liquidations, collateral swaps, and other advanced strategies.</p>

                        <div class="highlight">
                            <strong>üî• Flash Loan Benefits:</strong>
                            <ul>
                                <li>Borrow large amounts without collateral</li>
                                <li>Configurable fee (default: 9 basis points / 0.09%)</li>
                                <li>Available from any active market vault</li>
                                <li>Custom flash loan interface optimized for gas efficiency</li>
                                <li>Capital-efficient DeFi strategies</li>
                                <li>Built-in security and validation</li>
                            </ul>
                        </div>

                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-title">Understand Flash Loan Requirements</div>
                            <p>Flash loans must be borrowed and repaid within the same transaction, plus a configurable fee.</p>
                            
                            <div class="info-box blue">
                                <strong>Flash Loan Rules:</strong>
                                <ul>
                                    <li><strong>Same Transaction:</strong> Borrow and repay must happen in one atomic transaction</li>
                                    <li><strong>Fee Required:</strong> Configurable fee (default 9 basis points / 0.09%)</li>
                                    <li><strong>Sufficient Liquidity:</strong> Vault must have available funds</li>
                                    <li><strong>Valid Receiver:</strong> Must implement <code>IFlashLoanReceiver</code> interface</li>
                                    <li><strong>Success Return:</strong> executeOperation must return true</li>
                                </ul>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-title">Implement Flash Loan Receiver</div>
                            <p>Create a contract that can receive and handle flash loans using Lendefi's custom interface.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">import "../interfaces/IFlashLoanReceiver.sol";

contract MyFlashLoanReceiver is IFlashLoanReceiver {
    ILendefiMarketVault public immutable vault;
    
    constructor(address _vault) {
        vault = ILendefiMarketVault(_vault);
    }
    
    function executeOperation(
        address asset,
        uint256 amount,
        uint256 fee,
        address initiator,
        bytes calldata params
    ) external override returns (bool) {
        // Verify the call is from the vault
        require(msg.sender == address(vault), "Unauthorized caller");
        require(initiator != address(0), "Invalid initiator");
        
        // Your flash loan logic here
        _executeFlashLoanLogic(asset, amount, fee, params);
        
        // Ensure we have enough to repay (amount + fee)
        uint256 totalRepayment = amount + fee;
        require(
            IERC20(asset).balanceOf(address(this)) &gt;= totalRepayment,
            "Insufficient funds for repayment"
        );
        
        // Note: No need to approve - vault checks balance directly
        // The vault will verify we have sufficient balance after callback
        
        return true; // Must return true for successful execution
    }
    
    function _executeFlashLoanLogic(
        address asset,
        uint256 amount,
        uint256 fee,
        bytes calldata params
    ) internal {
        // Implement your strategy:
        // - Arbitrage between DEXes
        // - Liquidate positions
        // - Collateral swaps
        // - Portfolio rebalancing
        
        // Example: Decode parameters for strategy
        // (address targetDex, uint256 minProfit) = abi.decode(params, (address, uint256));
    }
}</code></pre>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-title">Execute Flash Loan</div>
                            <p>Call the flash loan function from the market vault with your parameters.</p>
                            
                            <div class="code-block">
                                <pre><code class="language-solidity">// Execute flash loan from Lendefi market vault
function executeFlashLoan(
    address vault,
    uint256 amount,
    bytes calldata params
) external {
    ILendefiMarketVault marketVault = ILendefiMarketVault(vault);
    
    // Check available liquidity in the vault
    address baseAsset = marketVault.asset();
    uint256 availableLiquidity = IERC20(baseAsset).balanceOf(vault);
    require(amount &lt;= availableLiquidity, "Insufficient vault liquidity");
    
    // Calculate the flash loan fee (typically 9 basis points = 0.09%)
    // Note: Fee is configurable per market, check actual fee before execution
    uint256 fee = (amount * 9) / 10000; // Example: 9 bps default
    
    // Ensure contract has enough to pay the fee
    require(
        IERC20(baseAsset).balanceOf(address(this)) &gt;= fee,
        "Insufficient fee balance"
    );
    
    // Execute flash loan
    marketVault.flashLoan(
        address(this),  // receiver contract
        amount,         // loan amount
        params         // custom data
    );
}</code></pre>
                            </div>
                        </div>

                        <h3>Common Flash Loan Use Cases</h3>
                        
                        <div class="grid-3">
                            <div class="info-box green">
                                <h5>üîÑ Arbitrage</h5>
                                <p>Exploit price differences between DEXes</p>
                                <ul>
                                    <li>Flash loan USDC</li>
                                    <li>Buy asset on DEX A</li>
                                    <li>Sell asset on DEX B</li>
                                    <li>Repay loan + fee</li>
                                    <li>Keep profit</li>
                                </ul>
                            </div>
                            
                            <div class="info-box blue">
                                <h5>‚ö° Liquidations</h5>
                                <p>Liquidate positions without capital</p>
                                <ul>
                                    <li>Flash loan base asset</li>
                                    <li>Liquidate position</li>
                                    <li>Receive collateral</li>
                                    <li>Swap collateral to base</li>
                                    <li>Repay loan + fee</li>
                                </ul>
                            </div>
                            
                            <div class="info-box purple">
                                <h5>üîÄ Collateral Swaps</h5>
                                <p>Change collateral types efficiently</p>
                                <ul>
                                    <li>Flash loan new collateral</li>
                                    <li>Add to position</li>
                                    <li>Remove old collateral</li>
                                    <li>Swap old to new</li>
                                    <li>Repay loan</li>
                                </ul>
                            </div>
                        </div>

                        <h3>Flash Loan Fee Structure</h3>
                        <div class="code-block">
                            <pre><code class="language-solidity">// Flash loan fee calculation
uint256 fee = (amount * 9) / 10000; // 0.09% = 9 basis points

// Examples:
// 1,000 USDC flash loan = 0.9 USDC fee
// 100,000 USDC flash loan = 90 USDC fee
// 1,000,000 USDC flash loan = 900 USDC fee

// Note: Fee is configurable per market (default: 9 basis points)
// Check market configuration for exact fee rates</code></pre>
                        </div>

                        <h3>Complete Flash Loan Example: Arbitrage</h3>
                        <div class="code-block">
                            <pre><code class="language-solidity">contract ArbitrageBot is IFlashLoanReceiver {
    ILendefiMarketVault public immutable vault;
    IUniswapV2Router public immutable uniswapRouter;
    ISushiswapRouter public immutable sushiRouter;
    
    constructor(address _vault, address _uniswap, address _sushi) {
        vault = ILendefiMarketVault(_vault);
        uniswapRouter = IUniswapV2Router(_uniswap);
        sushiRouter = ISushiswapRouter(_sushi);
    }
    
    function executeArbitrage(
        address tokenA,
        address tokenB,
        uint256 amount
    ) external {
        // Encode arbitrage parameters
        bytes memory data = abi.encode(tokenA, tokenB, amount);
        
        // Execute flash loan
        vault.flashLoan(address(this), amount, data);
    }
    
    function executeOperation(
        address asset,
        uint256 amount,
        uint256 fee,
        address initiator,
        bytes calldata params
    ) external override returns (bool) {
        require(msg.sender == address(vault), "Unauthorized");
        require(initiator != address(0), "Invalid initiator");
        
        // Decode parameters
        (address tokenA, address tokenB, uint256 flashAmount) = 
            abi.decode(params, (address, address, uint256));
        
        // Execute arbitrage strategy
        _performArbitrage(tokenA, tokenB, flashAmount);
        
        // Ensure we have enough to repay
        uint256 totalOwed = amount + fee;
        require(
            IERC20(asset).balanceOf(address(this)) &gt;= totalOwed,
            "Arbitrage not profitable"
        );
        
        // No need to approve - vault checks balance directly
        return true;
    }
    
    function _performArbitrage(
        address tokenA,
        address tokenB,
        uint256 amount
    ) internal {
        // 1. Buy tokenB on Uniswap with tokenA
        address[] memory path = new address[](2);
        path[0] = tokenA;
        path[1] = tokenB;
        
        IERC20(tokenA).approve(address(uniswapRouter), amount);
        uint256[] memory amounts = uniswapRouter.swapExactTokensForTokens(
            amount,
            0, // Accept any amount
            path,
            address(this),
            block.timestamp + 300
        );
        
        // 2. Sell tokenB on Sushiswap for tokenA
        uint256 tokenBReceived = amounts[1];
        path[0] = tokenB;
        path[1] = tokenA;
        
        IERC20(tokenB).approve(address(sushiRouter), tokenBReceived);
        sushiRouter.swapExactTokensForTokens(
            tokenBReceived,
            amount, // Ensure we get back at least what we borrowed
            path,
            address(this),
            block.timestamp + 300
        );
        
        // Profit is any excess tokenA we now have
    }
    
    // Extract profits
    function withdrawProfits(address token) external {
        uint256 balance = IERC20(token).balanceOf(address(this));
        IERC20(token).transfer(msg.sender, balance);
    }
}</code></pre>
                        </div>

                        <div class="warning">
                            <strong>‚ö†Ô∏è Flash Loan Risks:</strong>
                            <ul>
                                <li><strong>MEV Competition:</strong> Your transaction may be front-run by MEV bots</li>
                                <li><strong>Slippage:</strong> Price movements can make arbitrage unprofitable</li>
                                <li><strong>Gas Costs:</strong> Complex transactions consume significant gas</li>
                                <li><strong>Failed Repayment:</strong> Entire transaction reverts if you can't repay</li>
                                <li><strong>Smart Contract Risk:</strong> Bugs in your flash loan logic can cause losses</li>
                            </ul>
                        </div>

                        <div class="info-box green">
                            <strong>üí° Flash Loan Best Practices:</strong>
                            <ul>
                                <li><strong>Simulate First:</strong> Test your strategy on a fork before mainnet</li>
                                <li><strong>Calculate Fees:</strong> Always account for the 0.09% flash loan fee</li>
                                <li><strong>Slippage Protection:</strong> Use minimum output amounts in DEX swaps</li>
                                <li><strong>Gas Optimization:</strong> Optimize contract code for gas efficiency</li>
                                <li><strong>Profit Validation:</strong> Ensure strategy is profitable before executing</li>
                                <li><strong>Emergency Exits:</strong> Build in fallback mechanisms for failed strategies</li>
                            </ul>
                        </div>
                    </section>

                    <section id="collateral-tiers">
                        <h2>Collateral Tiers & Risk Parameters</h2>
                        <p>Different collateral assets are classified into risk tiers that determine borrowing capacity and interest rates.</p>

                        <table class="tier-table">
                            <thead>
                                <tr>
                                    <th>Tier</th>
                                    <th>Description</th>
                                    <th>Loan-to-Value</th>
                                    <th>Liquidation Threshold</th>
                                    <th>Interest Rate Premium</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>STABLE (0)</strong></td>
                                    <td>Stablecoins (USDC, USD1, USDT)</td>
                                    <td>~95%</td>
                                    <td>~98%</td>
                                    <td>Base Rate</td>
                                </tr>
                                <tr>
                                    <td><strong>CROSS_A (1)</strong></td>
                                    <td>Blue-chip assets (WETH, WBTC)</td>
                                    <td>~80%</td>
                                    <td>~85%</td>
                                    <td>Base + 1-2%</td>
                                </tr>
                                <tr>
                                    <td><strong>CROSS_B (2)</strong></td>
                                    <td>Established altcoins (UNI, LINK)</td>
                                    <td>~70%</td>
                                    <td>~75%</td>
                                    <td>Base + 2-4%</td>
                                </tr>
                                <tr>
                                    <td><strong>ISOLATED (3)</strong></td>
                                    <td>High-risk/volatile assets</td>
                                    <td>~60%</td>
                                    <td>~65%</td>
                                    <td>Base + 4-8%</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="grid-2">
                            <div class="info-box green">
                                <h5>‚úÖ Cross-Collateral Benefits</h5>
                                <ul>
                                    <li>Higher borrowing capacity</li>
                                    <li>Can use multiple assets in one position</li>
                                    <li>More flexible collateral management</li>
                                    <li>Better capital efficiency</li>
                                </ul>
                            </div>
                            
                            <div class="info-box yellow">
                                <h5>üîí Isolated Asset Considerations</h5>
                                <ul>
                                    <li>Limited borrowing capacity (debt caps)</li>
                                    <li>Cannot mix with other collateral types</li>
                                    <li>Higher interest rate premiums</li>
                                    <li>Reduced systemic risk</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section id="liquidation">
                        <h2>Liquidation Process</h2>
                        <p>Understanding liquidation is crucial for managing your borrowing positions safely.</p>

                        <div class="danger">
                            <strong>‚ö†Ô∏è Liquidation Risk:</strong> If your health factor drops below 1.0 due to collateral price decline or accrued interest, your position becomes eligible for liquidation. Monitor your positions regularly and maintain adequate collateral buffers.
                        </div>

                        <h3>Liquidation Triggers</h3>
                        <div class="info-box red">
                            <strong>Common Liquidation Causes:</strong>
                            <ul>
                                <li><strong>Price Decline:</strong> Collateral asset value drops significantly</li>
                                <li><strong>Interest Accumulation:</strong> Debt grows due to unpaid interest</li>
                                <li><strong>Collateral Withdrawal:</strong> Removing too much collateral</li>
                                <li><strong>Market Volatility:</strong> Rapid price movements</li>
                            </ul>
                        </div>

                        <h3>Liquidation Process Steps</h3>
                        <div class="grid-2">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <div class="step-title">Detection</div>
                                <p>Anyone can check if a position is liquidatable using <code>isLiquidatable()</code> function.</p>
                            </div>

                            <div class="step-card">
                                <div class="step-number">2</div>
                                <div class="step-title">Liquidation Call</div>
                                <p>Liquidators call <code>liquidate()</code> with sufficient governance tokens as threshold.</p>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="step-card">
                                <div class="step-number">3</div>
                                <div class="step-title">Collateral Sale</div>
                                <p>Protocol sells collateral to repay debt, liquidator receives bonus.</p>
                            </div>

                            <div class="step-card">
                                <div class="step-number">4</div>
                                <div class="step-title">Position Closure</div>
                                <p>Position status changes to LIQUIDATED, remaining collateral can be claimed.</p>
                            </div>
                        </div>

                        <div class="info-box blue">
                            <strong>Liquidation Protection Strategies:</strong>
                            <ul>
                                <li><strong>Conservative LTV:</strong> Borrow well below maximum capacity</li>
                                <li><strong>Health Factor Buffer:</strong> Maintain HF above 1.5</li>
                                <li><strong>Price Monitoring:</strong> Watch collateral asset prices</li>
                                <li><strong>Automatic Alerts:</strong> Set up position monitoring tools</li>
                                <li><strong>Diversified Collateral:</strong> Use multiple assets to reduce correlation risk</li>
                            </ul>
                        </div>
                    </section>

                    <section id="mev-protection">
                        <h2>MEV Protection</h2>
                        <p>Lendefi Markets includes comprehensive MEV protection mechanisms to safeguard borrowers.</p>

                        <div class="grid-3">
                            <div class="info-box blue">
                                <h5>üõ°Ô∏è Same-Block Prevention</h5>
                                <ul>
                                    <li>Prevents multiple operations by same user in one block</li>
                                    <li>Protects against sandwich attacks</li>
                                    <li>Applies to all position operations</li>
                                </ul>
                            </div>
                            
                            <div class="info-box green">
                                <h5>üìä Slippage Protection</h5>
                                <ul>
                                    <li>Expected amount parameters</li>
                                    <li>Maximum slippage controls</li>
                                    <li>Transaction reverts if exceeded</li>
                                </ul>
                            </div>
                            
                            <div class="info-box purple">
                                <h5>üîÆ Oracle Protection</h5>
                                <ul>
                                    <li>Dual oracle system prevents manipulation</li>
                                    <li>Time-weighted average prices</li>
                                    <li>Circuit breakers for large deviations</li>
                                </ul>
                            </div>
                        </div>

                        <div class="code-block">
                            <pre><code class="language-solidity">// All major operations include MEV protection parameters
marketCore.borrow(
    positionId,
    borrowAmount,
    expectedCreditLimit,  // MEV protection: expected credit limit
    maxSlippageBps       // MEV protection: maximum slippage in basis points
);

// Slippage protection example:
// If you expect to borrow $80,000 but slippage is set to 100 bps (1%)
// Transaction will revert if you receive less than $79,200</code></pre>
                        </div>
                    </section>

                    <section id="examples">
                        <h2>Complete Borrowing Example</h2>
                        
                        <div class="code-block">
                            <pre><code class="language-solidity">// Complete borrowing lifecycle example
contract BorrowerExample {
    ILendefiCore marketCore;
    IERC20 weth;
    IERC20 usdc;
    
    function completeBorrowingCycle() external {
        uint256 positionId;
        uint256 collateralAmount = 50 ether; // 50 WETH
        uint256 borrowAmount = 80_000e6;     // 80,000 USDC
        
        // Step 1: Create position for WETH collateral
        positionId = marketCore.createPosition(address(weth), false);
        
        // Step 2: Supply collateral
        weth.approve(address(marketCore), collateralAmount);
        marketCore.supplyCollateral(address(weth), collateralAmount, positionId);
        
        // Step 3: Check credit limit and borrow
        uint256 creditLimit = marketCore.calculateCreditLimit(msg.sender, positionId);
        require(borrowAmount &lt;= creditLimit, "Insufficient credit");
        
        marketCore.borrow(positionId, borrowAmount, creditLimit, 100);
        
        // Step 4: Monitor position (should be called regularly)
        monitorPosition(positionId);
        
        // Step 5: Repay and close (when ready)
        repayAndClose(positionId);
    }
    
    function monitorPosition(uint256 positionId) public view returns (
        uint256 healthFactor,
        uint256 currentDebt,
        bool needsAttention
    ) {
        healthFactor = marketCore.healthFactor(msg.sender, positionId);
        currentDebt = marketCore.calculateDebtWithInterest(msg.sender, positionId);
        needsAttention = healthFactor &lt; 1.5e6; // Health factor below 1.5
        
        if (needsAttention) {
            // Consider adding collateral or repaying debt
        }
    }
    
    function repayAndClose(uint256 positionId) external {
        // Calculate total debt with interest
        uint256 totalDebt = marketCore.calculateDebtWithInterest(msg.sender, positionId);
        uint256 repayAmount = totalDebt + 100e6; // Add buffer
        
        // Repay debt
        usdc.approve(address(marketCore), repayAmount);
        marketCore.repay(positionId, repayAmount, totalDebt, 100);
        
        // Withdraw all collateral
        uint256 collateralBalance = marketCore.getCollateralAmount(
            msg.sender, 
            positionId, 
            address(weth)
        );
        
        marketCore.withdrawCollateral(
            address(weth),
            collateralBalance,
            positionId,
            0, // Expected credit limit after full repay
            100
        );
    }
    
    // Emergency function to add collateral if health factor is low
    function addEmergencyCollateral(uint256 positionId, uint256 amount) external {
        require(
            marketCore.healthFactor(msg.sender, positionId) &lt; 1.2e6, 
            "Position is healthy"
        );
        
        weth.approve(address(marketCore), amount);
        marketCore.supplyCollateral(address(weth), amount, positionId);
    }
    
    // Function to partially repay debt to improve health factor
    function improveHealthFactor(uint256 positionId, uint256 repayAmount) external {
        usdc.approve(address(marketCore), repayAmount);
        
        uint256 currentDebt = marketCore.calculateDebtWithInterest(msg.sender, positionId);
        marketCore.repay(positionId, repayAmount, currentDebt, 100);
    }
}</code></pre>
                        </div>

                        <div class="highlight">
                            <strong>üí° Pro Tips for Borrowers:</strong>
                            <ul>
                                <li><strong>Conservative Borrowing:</strong> Never borrow more than 70-80% of your maximum credit limit</li>
                                <li><strong>Health Factor Monitoring:</strong> Set up alerts when health factor drops below 1.5</li>
                                <li><strong>Interest Management:</strong> Monitor interest accrual and repay periodically</li>
                                <li><strong>Price Correlation:</strong> Avoid using highly correlated assets as collateral and borrow target</li>
                                <li><strong>Liquidity Buffer:</strong> Keep some borrowed funds available for emergency collateral additions</li>
                                <li><strong>Position Sizing:</strong> Start with smaller positions to learn the system before scaling up</li>
                            </ul>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>